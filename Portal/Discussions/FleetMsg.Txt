================================= dz's netmail =================================
   From: Alexey Roschin                      2:5030/133.38   04 Nov 96  18:10:18
     To: Dmitry Zavalishin                   2:5020/32       05 Nov 96  06:52:52
   Subj: Семафоры                                                               
================================================================================
Hi, Dmitry!

01 Nov 96 05:58, Dmitry Zavalishin wrote to Alexey Roschin next things:

      Идем по 3 кругу :)

 DZ>>> Только что попробовал укусить
 DZ>>> проблему с малтитредностью и потерями на семафорах. Придумал вот что:
 DZ>>> если потратить, скажем, регистр (ну, это я мечтаю:) и ввести флаг
 DZ>>> "для объектов, полностью содержащихся в данном объекте гарантируется
 DZ>>> синглтредность", то можно не запирать внутри эти содержимые объекты,
 DZ>>> если надежно заперся контейнер. Им можно даже память на семафор не
 DZ>>> выделять.

     1. Любишь объекты и хочешь выдоить из них все (как Резерфорд из 
альфа-частицы).
     2. Hарвался на неприспособленность нынешней реализации объектов к 
малтитредности.
     3. Хочешь прятать объекты за однотредный барьер и применять в качестве 
оного контейнер с быстрым семафором. Как коммунизм в отдельно взятой...
Инкапсулировать семафор в контейнере.

 DZ>>> Кстати, если бы ввести в процессор запасной флажок в PSW для этого
 DZ>>> дела, то было бы вообще гениально. А есть и совсем потрясающее
 DZ>>> решение, если модифицировать проц и операционку: завести
 DZ>>> спецрегистр, который содержит адрес семафора или 0. В момент
 DZ>>> переключения тредов он анализируется ОС, и если не нулевой, то
 DZ>>> указаный семафор запирается. Если уже заперт - сбиваем задачу по
 DZ>>> GPF. :) Как тебе идея? Запатентовать, разве? :) Инетересно - сложно
 DZ>>> ли это?

      Заявка на патент - 15 к$ :( Дальше рассказывать?

 AR>> С чего семафор должен запираться в момент переключения тредов?
 DZ> А чтобы не переключать его пока реально не приперло. Ведь пока тред не
 DZ> переключался и семафорить не нужно!

    Теперь дошло. Можно локально проскакивать защищенный участок без обращения к 
механизмам ос.
    Он нереентерабелен для того же треда. Хотя, несколько локов, как ты говорил, 
можно застекерить.
    А где защита от падения треда, иксепшена? Hадо try-finally городить для 
спасения семафора. Пришел-ушел. Эффективность все равно упадет.

 AR>> И что такое быстрый/полный семафор.
 DZ> Быстрый - это без помощи ОС, lock xchg, если не вру мнемонику. То есть

    Врешь :)                           ^^^^ - при участии памяти ВСЕГДА дает 
блокировку шины данных. То есть, префикс не нужен. А почему xchg, а не bts? Она, 
вроде, тоже подходит. lock нужен явный. Зато сразу CF выдает. xchg флаги не 
меняет.

 DZ> запираем память и атомарно обмениваемся байтом. Отдаем 1, если получили 0
 DZ> - идем и работаем, получили 1 - виснем на системном
 DZ> event-семафоре (медленном) чтобы проц отдать. Будит нас тот, кто запер
 DZ> быстрый, когда он его отопрет.

    Если не сдохнет. Я все-таки представляю семафор в виде структуры данных при 
объекте, где есть id треда (для реентерабельности и на случай издыхания треда и 
принудительного разблокирования данных) и счетчик рекурсивных вхождений. А вот 
очередь ждущих можно и похерить. Пусть дерутся. Двойного слова хватит.
    А полный очень страшный? Чего там напихано?

 DZ> Я, дурак, не удержался - досконально знал, чем кончится, и все равно. Hу
 DZ> да ладно - если глупостей не делать, жизнь омерзительно предсказуема и
 DZ> скучна. :):) (Оригин, однако.;) Долой детерминизм.

    Hа то ты и щука, чтобы караси не дремали :) Да и дразниться тоже приятно. 
Человек - существо подлое. Хочет других на чистую воду/поле :) вывести.

 DZ> Origin: Have you got four sigils yet? (2:5020/32)

    Это цитата? Кто такие сигилы? Семафоры или бабы? :)

Best regards, Alexey
--- 2.41+
 * Origin: MARGO station (2:5030/133.38)

