/************************ UU2 Library ***************************\
 *
 *	Copyright (C) 1991,1992 by Infinity Soft
 *
 *	Module 	:	Code table convertor kernel
 *
 *      $Log:   Q:/lib/uu2/vcs/recode.c_v  $
 *      
 *         Rev 1.3   07 Jun 1993 17:51:06   dz
 *      const
 *      
 *         Rev 1.2   16 Oct 1992 03:36:12   dz
 *      New codetable by Leo Broukhis
 *      
 *         Rev 1.1   07 Jul 1992 01:03:32   dz
 *      Russian 'H' replaced with latin 'H' in KOI-CP866 table
 *      
 *         Rev 1.0   04 Feb 1992 22:01:40   dz
 *      Initial revision.
 *
 *
 *
\*/

#include	<style.h>
#include	<stddef.h>
#include	<string.h>
#include	"recode.h"

extern uchar		cp866_to_koi8[];
extern uchar		koi8_to_cp866[];
extern uchar		leo_to_cp866[];






struct ctt									// CodeTable table
	{
	char	*name;							// CodeTable name
	char	*tab;							// Table itself
	};

ctt	ct_tab[] =
	{
		{ "CP866-KOI8",			cp866_to_koi8	},
		{ "KOI8-CP866",			koi8_to_cp866	},
		{ "LEO-CP866",			leo_to_cp866	}
	};

#define	CTT_SIZE	(sizeof(ct_tab)/sizeof(ctt))

recoder::
recoder( const char *tabname )
	{

	tab = NULL;

	if( stricmp( tabname, "none" ) == 0 || strlen( tabname ) == 0 )
		{
		alloced = No;
		bad = No;
		return;
		}

	bad = Yes;

	for( int i = 0; i < CTT_SIZE; i++ )
		if( !stricmp( tabname, ct_tab[i].name ) )
			{
			tab = ct_tab[i].tab;
			alloced = No;
			bad = No;
			return;
			}

	// Ok, here we can try to load something from file
	}



recoder::~recoder()
	{
	}

bool
recoder::valid()						// This instnce was constructed
	{
	return (bool)!bad;
	}


uchar
recoder::rc( uchar c )					// Recode character
	{

	if( c < 0x80 || tab == NULL )
		return c;

	return tab[c-0x80];
	}


void
recoder::rs( uchar *s )					// Recode string
	{

	if( tab == NULL )
		return;

	while( *s )
		{
		if( *s < 0x80 )
			{
			s++;
			continue;
			}
		*s = tab[(*s)-0x80];
		s++;
		}
	}




/****************************************************************************
							Built-in tables
****************************************************************************/


static uchar
cp866_to_koi8[] =
  {
  0xe1, 0xe2, 0xf7, 0xe7, 0xe4, 0xe5, 0xf6, 0xfa,
  0xe9, 0xea, 0xeb, 0xec, 0xed, 0xee, 0xef, 0xf0,
  0xf2, 0xf3, 0xf4, 0xf5, 0xe6, 0xe8, 0xe3, 0xfe,
  0xfb, 0xfd, 0xff, 0xf9, 0xf8, 0xfc, 0xe0, 0xf1,
  0xc1, 0xc2, 0xd7, 0xc7, 0xc4, 0xc5, 0xd6, 0xda,
  0xc9, 0xca, 0xcb, 0xcc, 0xcd, 0xce, 0xcf, 0xd0,
  0x80, 0x81, 0x82, 0x83, 0x84, 0x85, 0x86, 0x87,
  0x88, 0x89, 0x8a, 0x8b, 0x8c, 0x8d, 0x8e, 0x8f,
  0x90, 0x91, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97,
  0x98, 0x99, 0x9a, 0xbf, 0x9c, 0x9d, 0x9e, 0x9f,
  0xa0, 0xa1, 0xa2, 0xb0, 0xa4, 0xa5, 0xa6, 0xa7,
  0xa8, 0xa9, 0xaa, 0xab, 0xac, 0xad, 0xae, 0xaf,
  0xd2, 0xd3, 0xd4, 0xd5, 0xc6, 0xc8, 0xc3, 0xde,
  0xdb, 0xdd, 0xdf, 0xd9, 0xd8, 0xdc, 0xc0, 0xd1,
  0xb3, 0xa3, 0xb2, 0xb1, 0xb4, 0xb5, 0xb6, 0xb7,
  0xb8, 0xb9, 0xba, 0xbb, 0xbc, 0xbd, 0xbe, 0x9b,
  };


static uchar
koi8_to_cp866[] =
  {
  0xb0, 0xb1, 0xb2, 0xb3, 0xb4, 0xb5, 0xb6, 0xb7,	// 128
  0xb8, 0xb9, 0xba, 0xbb, 0xbc, 0xbd, 0xbe, 0xbf,	// 136
  0xc0, 0xc1, 0xc2, 0xc3, 0xc4, 0xc5, 0xc6, 0xc7,	// 144
  0xc8, 0xc9, 0xca, 0xff, 0xcc, 0xcd, 0xce, 0xcf,	// 152

  0xd0, 0xd1, 0xd2, 0xf1, 0xd4, 0xd5, 0xd6, 0xd7,	// 160
  0xd8, 0xd9, 0xda, 0xdb, 0xdc, 0xdd, 0xde, 0xdf,	// 168
  0xd3, 0xf3, 0xf2, 0xf0, 0xf4, 0xf5, 0xf6, 0xf7,	// 176
  0xf8, 0xf9, 0xfa, 0xfb, 0xfc, 0xfd, 0xfe, 0xcb,	// 184

  0xee, 0xa0, 0xa1, 0xe6, 0xa4, 0xa5, 0xe4, 0xa3,	// 192
  0xe5, 0xa8, 0xa9, 0xaa, 0xab, 0xac, 0xad, 0xae,	// 200
  0xaf, 0xef, 0xe0, 0xe1, 0xe2, 0xe3, 0xa6, 0xa2,	// 208
  0xec, 0xeb, 0xa7, 0xe8, 0xed, 0xe9, 0xe7, 0xea,	// 216

  0x9e, 0x80, 0x81, 0x96, 0x84, 0x85, 0x94, 0x83,	// 224
//  0x95, 0x88, 0x89, 0x8a, 0x8b, 0x8c, 0x8d, 0x8e,	// 232
  0x95, 0x88, 0x89, 0x8a, 0x8b, 0x8c,  'H', 0x8e,	// FIDO soft CR!!
  0x8f, 0x9f, 0x90, 0x91, 0x92, 0x93, 0x86, 0x82,	// 240
  0x9c, 0x9b, 0x87, 0x98, 0x9d, 0x99, 0x97, 0x9a,	// 248
  };


// From:  Leonid A. Broukhis <leo@s514.ipmce.su>

static uchar
leo_to_cp866[] =
  {
  '°', '±', '²', '³', '´', 'µ', '¶', '·',	// 128
  '¸', '¹', 'º', '»', '¼', '½', '¾', '¿',	// 136
  'À', 'Á', 'Â', 'Ã', 'Ä', 'Å', 'Æ', 'Ç',	// 144
  'È', 'É', 'Ê', '?', 'Ì', 'Í', 'Î', 'Ï',	// 152

  'Ð', 'Ñ', 'Ò', 'ò', 'Ô', 'Õ', 'Ö', '×',	// 160
  'Ø', 'Ù', 'Ú', 'Û', 'Ü', 'Ý', 'Þ', 'ß',	// 168
  'Ó', 'ó', 'ò', 'ñ', 'ô', 'õ', 'ö', '÷',	// 176
  'ø', 'ù', 'ú', 'û', 'ü', 'ý', 'þ', 'Ë',	// 184

  0xee, 0xa0, 0xa1, 0xe6, 0xa4, 0xa5, 0xe4, 0xa3,	// 192
  0xe5, 0xa8, 0xa9, 0xaa, 0xab, 0xac, 0xad, 0xae,	// 200
  0xaf, 0xef, 0xe0, 0xe1, 0xe2, 0xe3, 0xa6, 0xa2,	// 208
  0xec, 0xeb, 0xa7, 0xe8, 0xed, 0xe9, 0xe7, 0xea,	// 216

  0x9e, 0x80, 0x81, 0x96, 0x84, 0x85, 0x94, 0x83,	// 224
//  0x95, 0x88, 0x89, 0x8a, 0x8b, 0x8c, 0x8d, 0x8e,	// 232
  0x95, 0x88, 0x89, 0x8a, 0x8b, 0x8c,  'H', 0x8e,	// FIDO soft CR!!
  0x8f, 0x9f, 0x90, 0x91, 0x92, 0x93, 0x86, 0x82,	// 240
  0x9c, 0x9b, 0x87, 0x98, 0x9d, 0x99, 0x97, 0x9a,	// 248
  };





